---
title: "_Лабораторна робота №4._ Побудова моделі класифікації"
author: "[Зайкін А. В.](https://www.linkedin.com/in/zaykinandrew/), `r format(Sys.time(), '%Y')`"
date: "`r Sys.Date()`"
output:
  html_notebook:
    toc: yes
    toc_float: 
      collapsed: false
      smooth_scroll: true
    highlight: tango
    code-fold: true
    code-line-numbers: true
    code-tools: true
    code-copy: true
fontsize: 12pt
lang: ukr
header-includes:
 \usepackage[T2A]{fontenc}
 \usepackage[utf8]{inputenc}
 \usepackage[russian]{babel}
editor_options: 
  chunk_output_type: console
---

# Короткі теоретичні відомості

### Що таке асоціативні правила?
Асоціативні правила (англ. Association Rules) - це методи статистичного моделювання, які використовуються для аналізу залежності між двома змінними: залежною та незалежною. Залежна змінна - це та, яка залежить від іншої змінної, а незалежна змінна - це та, яка впливає на залежнuу змінну.

### Що таке алгоритм Apriori?
Алгоритм Apriori (англ. Apriori) - це алгоритм, який використовується для побудови моделі асоціативних правил. Алгоритм Apriori є одним з найпопулярніших алгоритмів для побудови моделі асоціативних правил.

# Постановка задачі

### Мета роботи:
1. Засвоєння принципів, знайомство з інструментами та набуття навичок побудови моделі асоціативних правил засобами мови програмування R та пакетів `arules`.
2. Побудова моделі асоціативних правил за допомогою алгоритму Apriori.
3. Аналіз результатів моделі асоціативних правил.

# Виконання завдання

```{r warning=FALSE, message=FALSE, include=FALSE, paged.print=FALSE}
packages <- c("rio", "tidyverse", "arules")
lapply(packages, library, character.only = TRUE, quietly = TRUE)
```

Візьмемо датасет `Titanic` з пакету `arules`. Датасет містить дані про пасажирів лайнера "Титанік", які померли під час круїзу. Датасет містить такі змінні:

```{r}
library(rio)
df <- as.data.frame(Titanic)
head(df)
```

- `Class` - клас пасажира
- `Sex` - стать пасажира
- `Age` - вік пасажира
- `Survived` - чи вижив пасажир
- `Freq` - частота появи пасажира в датасеті

Тепер використаємо функцію `as_tibble()` пакету `tidyverse` для конвертації датасету у формат `tidy` де з'являється колонка 'n' (кількість випадків). Потім ми використовуємо uncount(n), щоб розгорнути агреговані дані. Це критичний крок: він створює окремий рядок для кожного пасажира.

```{r}
titanic_raw <- as_tibble(Titanic) %>%
  uncount(n) %>%
  mutate(across(everything(), as.factor))

head(titanic_raw)
```

Тепер ми можемо побудувати модель асоціативних правил. Бiльш цiкавою є частина правил, де залежна змінна - вижив чи не вижив пасажир. Виведемо правила для виживших пасажирів. 

```{r}
rules <- apriori(titanic_raw, 
                 parameter = list(minlen = 2, supp = 0.005, conf = 0.8),
                 appearance = list(rhs = c("Survived=No", "Survived=Yes"), 
                                   default = "lhs"),
                 control = list(verbose = FALSE))
```

Параметри моделі ми вибрали такі:

- `minlen` - мінімальна довжина правила (2)
- `supp` - мінімальна підтримка правила (0.005)
- `conf` - мінімальна довіра правила (0.8)

Лiва частина правила - клас, стать, вік пасажира. Права частина правила - вижив чи не вижив пасажир.

Тепер побудуємо таблицi частих наборів об'єктів, які часто зустрічаються в датасеті.

```{r}
rules_sorted <- sort(rules, by = "lift")

as(rules_sorted, "data.frame") %>% knitr::kable()
```

```{r}
rules_survived <- subset(rules, rhs %in% "Survived=Yes")
rules_survived_sorted <- sort(rules_survived, by = "confidence")

as(rules_survived_sorted, "data.frame") %>% knitr::kable()
```

```{r}
rules_died <- subset(rules, rhs %in% "Survived=No")
rules_died_sorted <- sort(rules_died, by = "confidence")

as(rules_died_sorted, "data.frame") %>% knitr::kable()
```

З усього набору даних можемо вивести асоціативні правил, кожне з яких розкриває окремий аспект катастрофи:

- **Пріоритет виживання жінок**: Правило `{Sex=Female} => {Survived=Yes}` зазвичай дає підтримку приблизно 0.15 і довіру 0.73 по всьому кораблю. Однак, коли ми деталізуємо це за класом, довіра створює різкий градієнт. Ліфт 3.01 для жінок 1-го класу є найвищим у наборі даних. Це вказує на те, що соціальний механізм «Титаніка» спрацював майже ідеально для цієї демографічної групи.
- **Абсолютна безпека окремих дітей**: Одним з найяскравіших знайдених правил є `{Class=2nd, Age=Child} => {Survived=Yes}`, яке часто показує довіру 1.0 (100%). Це означає, що діти 2-го класу мали найвищі шанси на виживання. Це означає, що кожна дитина, записана в даних 2-го класу, вижила. Це правило фактично сильніше, ніж правило для дітей 1-го класу, де сталася невелика кількість жертв.
- **Тупик для «чоловіків у трюмі»**: Правило `{Class=3rd, Sex=Male} => {Survived=No}` є одним з найнадійніших у наборі даних. 
	- **Підтримка (Support)**: Висока (~0.19), що означає, що ця демографічна група становить майже 20% усіх пасажирів.
  - **Довіра (Confidence)**: ~0.83. Більше ніж 4 з 5 чоловіків у 3-му класі загинули.
  - **Ліфт (Lift)**: ~1.22. Цей ліфт нижчий, ніж ліфт виживання для жінок, оскільки базовий рівень смертності вже був високим (68%). Однак довіра підтверджує, що для цієї групи смерть була статистичною нормою.
- **Фактор «Екіпажу»**: Важливим правилом є {Class=Crew} => {Sex=Male} (Довіра ~0.97) та {Class=Crew} => {Survived=No}. Екіпаж, що складався майже повністю з чоловіків, зазнав величезних втрат. Проте при порівнянні Екіпажу з 3-м класом виникають цікаві асоціативні патерни. Хоча обидві групи мали високу смертність, причини асоціації відрізняються. Чоловіки 3-го класу часто були заблоковані плануванням корабля; чоловіки екіпажу були заблоковані обов'язком. Структура даних R Titanic групує ці різні причини в схожі статистичні результати.
